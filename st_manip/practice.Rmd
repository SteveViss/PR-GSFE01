---
title: "Handling and visualizing spatiotemporal data"
author: Guillaume Blanchet & Steve Vissault
date: November 20th, 2019
output:
  html_document:
    highlight: tango
    toc: true
    toc_float: true
---

# Handling and visualizing spatiotemporal data

## Handling spatiotemporal data

### Dealing with spacetime

The mutlidimensionnality problem.

But manipulating such structure un R could be complicated.

### Spatial Vectors: CSV / Shapefiles

## OBIS data 

```{r}
library(devtools)
devtools::install_github("iobis/robis")
library(robis)
library(mapview)
library(sf)

halibut <- occurrence(scientificname = "Hippoglossus hippoglossus")
unique(my_occs$datasetName)
sf_halibut <- st_as_sf(halibut, coords = c("decimalLongitude","decimalLatitude"), crs = 4326)
mapview(sf_halibut)
```

## Dealing with dates

You also have to know the projection and make sure the time column has been converted to a `date` format.

```{r}
TODO
```

## Raster 

- NetCDF
- RasterStack structure
- Date in layer names

## Visualizing spatiotemporal data

## Plot points

Spatial points through time

## Points to raster

Offers more readibility (especialy with large number of points)
rasterize with count

### Interactive Maps to compare year through space

m1 <- mapview(breweries, zcol = "village", map.types = "Esri.WorldImagery")
m2 <- mapview(breweries, zcol = "brewery", col.regions = heat.colors)
m3 <- mapview(breweries, zcol = "founded", legend = TRUE)
sync(m1, m2, m3)

## Studying variablity on points

Taking advantage of continous surface 

Spatial variability


Times variobility


### Statics Maps

## Plot gridded data

http://iridl.ldeo.columbia.edu/SOURCES/.CAC/.sst/data.nc

```{r}
download.file('http://iridl.ldeo.columbia.edu/SOURCES/.CAC/.sst/data.nc', destfile = 'SST.nc')
SST <- stack('./assets/data/SST.nc')
idx <- seq(as.Date('1970-01-01'), as.Date('2003-03-01'), by='month')
tt <- as.yearmon(idx)
SST <- setZ(SST, tt)
names(SST) <- as.character(tt)

## Extract month value from a Date or yearmon object
month <- function(x)format(x, '%m')
## Compute anomaly using monthly grouping with ave  
anomaly <- function(x){
    ## Monthly means
    mm <- ave(x, month(tt), FUN = mean)
    ## Monthly standard deviation
    msd <- ave(x, month(tt), FUN = sd)
    ## anomaly
    (x - mm)/msd
}
## Use anomaly with calc
SSTanom <- calc(SST, anomaly)
SSTanom <- setZ(SSTanom, tt)

## Ok, let's see the result
hovmoller(SSTanom,
          at = seq(-3, 3, .25),
          panel = panel.levelplot.raster,
          interpolate = TRUE,
          yscale.components = yscale.raster.subticks,
          par.settings = BuRdTheme)
```

## Organize the spacetime data

### `spacetime` analysis in R

Exploring the spatio-temporal data aspect will require to construct a space-time object
with the function `stConstruct` (`spacetime package`). The data structure that we will use as an input
for the function has to be in a similar way (see below) where each row
corresponds to a sample taken at a specific time and location.

```{r}
library(spacetime)
library(sp)

spaceTime_air <- stConstruct(raw_air, c("lng","lat"),"dates", crs = CRS("+init=epsg:4326"))
class(spaceTime_air)
```

Class of `spacetime`

- full grid (STF), a combination of any sp object and any xts object to represent all
possible locations on the implied space-time lattice;
- sparse grid (STS), as STF, but contains only the non-missing space-time combinations on a space-time lattice;
- irregular (STI), an irregular space-time data structure, where each point is allocated a spatial coordinate and a time stamp;
- simple trajectories (STT), a sequence of space-time points that form trajectories.

```{r}
raw_air_2005_2010 <- subset(raw_air, dates > as.Date("2005-01-01") & dates < as.Date("2010-12-31"))

STIDF_air_2005_2010 <- stConstruct(raw_air_2005_2010, c("lng","lat"),"dates", crs = CRS("+init=epsg:4326"))
STFDF_air_2005_2010 <- as(STIDF_air_2005_2010, "STFDF")
summary(STFDF_air_2005_2010)

stplot(STFDF_air_2005_2010)
```




