---
title: "Spatio-temporal variograms"
author: Guillaume Blanchet & Steve Vissault
date: November 21th, 2019
output:
  html_document:
    highlight: tango
    toc: true
    toc_float: true
---

# Prepare the R environment

We load the packages needed for this practice.

```{r}
# Spatial 
library(sf)
library(sp) # for some analysis
library(dplyr) 
# Analysis
library(gstat)
library(spacetime)
# visualization
library(mapview)
```

## Get access to the data

[Download PM10 air quality data]("assets/data/air.rds")


# Load data

For this section, we will use the Air quality data obtained from the airBase
European air quality data base. Daily averages for rural background stations in
Germany, 1998-2009. Using a nationwide network of monitoring sites, EPA has
developed ambient air quality trends for particle pollution, also called
Particulate Matter (PM). PM10 used in this dataset describes inhalable
particles, with diameters that are generally 10 micrometers and smaller. 

```{r, echo = FALSE}
library(spacetime)
# load the data
data(air)
# melt the matrix
colnames(air) <- 1:ncol(air)
raw_air <- reshape2::melt(air, na.rm = TRUE)
names(raw_air) <- c("station_id","time_id","pm10")

# Add ids
dates <- data.frame(time_id=1:length(dates) ,dates = dates)
stations <- as.data.frame(stations, xy = TRUE)
stations$station_id <- rownames(stations)

# merge time
raw_air <- merge(raw_air,dates)
raw_air <- merge(raw_air,stations)

# Clean the air df
raw_air <- raw_air[,-2]
names(raw_air)[4:5] <- c("lng","lat")

saveRDS(raw_air,"./assets/data/pm10_germany.rds")
```

```{r}
pm10 <- readRDS("./assets/data/pm10_germany.rds")
head(pm10)
pm10_20090306 <- st_as_sf(subset(pm10, dates == "2009-03-06") ,coords = c("lng", "lat"), crs = 4326)
mapview(pm10_20090306, zcol = "pm10")
```

# Prepare the data

To reduce the computation time, we focus on the period 2005-2010.

```{r}
pm10_2005_2010 <- subset(pm10, dates > as.Date("2005-01-01") & 
                                     dates < as.Date("2010-12-31"))

STIDF_pm10_2005_2010 <- stConstruct(pm10_2005_2010, c("lng","lat"),"dates", crs = CRS("+init=epsg:4326"))
STFDF_pm10_2005_2010 <- as(STIDF_pm10_2005_2010, "STFDF")
summary(STFDF_pm10_2005_2010)
```


# Build empricial spatio-temporal variogram

```{r, cache = TRUE}
pm10_vario <- variogram(pm10~1, STFDF_pm10_2005_2010, width=20, cutoff = 200, tlags=0:5)
plot(pm10_vario)
plot(pm10_vario, wireframe = TRUE)
```

## Model variogram

### Declare the model

```{r echo=FALSE, out.width="80%"}
knitr::include_graphics("https://aegis4048.github.io/jupyter_images/basic_variogram.png")
```

The argument `sill` that is supplied to `vgmST` (below) defines the joint spatio-temporal sill.

```{r, cache = TRUE}
# Declare the model variogram 
separableModel <- vgmST("separable", 
                        method = "Nelder-Mead", # no lower & upper needed
                        space = vgm(psill = 0.9, model = "Exp", range = 123, nugget = 0.1),
                        time = vgm(psill = 0.9, model = "Exp", range = 2.9, nugget = 0.1),
                        sill = 100)

```

The function `fit.StVariogram` will use the `optim` function to optimize and
find the best set of parameters for the model variogram using the mean squared
errors. 

```{r, warnings = FALSE, cache = TRUE}
# fit the separableModel variogram 
separableModel <- fit.StVariogram(pm10_vario, separableModel,
                                  method="BFGS")
# metric model
metricModel <- vgmST("metric",
                     method = "Nelder-Mead", # no lower & upper needed
                     joint=vgm(0.9, "Exp", 123, 0.1),
                     stAni=100)

metricModel <- fit.StVariogram(pm10_vario, metricModel,
                                  method="BFGS")

```

But many other possibilities

```r
# product sum model: spatial and temporal nugget will be ignored and kept
# constant at 0. Only a joint nugget is used.
prodSumModel <- vgmST("productSum",
                      space=vgm(39, "Sph", 343, 0),
                      time= vgm(36, "Exp",   3, 0), 
                      k=15)

# sum metric model: spatial, temporal and joint nugget will be estimated
sumMetricModel <- vgmST("sumMetric",
                        space=vgm( 6.9, "Lin", 200, 3.0),
                        time =vgm(10.3, "Lin",  15, 3.6),
                        joint=vgm(37.2, "Exp",  84,11.7),
                        stAni=77.7)
                       
# simplified sumMetric model, only a overall nugget is fitted. The spatial, 
# temporal and jont nuggets are set to 0.
simpleSumMetricModel <- vgmST("simpleSumMetric",
                              space=vgm(20,"Lin", 150, 0),
                              time =vgm(20,"Lin", 10,  0),
                              joint=vgm(20,"Exp", 150, 0),
                              nugget=1, stAni=15)
```

### Assess model quality

You can get the mean squared errors within the output of the function
`fit.StVariogram()` with the following command line and compare them. 

```{r}
attr(separableModel,"optim")$value
attr(metricModel,"optim")$value
```

```{r, fig.width = 10}
library(lattice)
plot(pm10_vario, list(separableModel, metricModel), all=T, wireframe=T, zlim=c(0,120),
    zlab=NULL,
    xlab=list("distance (km)", rot=30),
    ylab=list("time lag (days)", rot=-35),
    scales=list(arrows=F, z = list(distance = 5)))
```

## Spatio-temporal krigging

We subset 3 days within the STSDF in order to reduce the krigging computation time.

```{r}
STFDF_pm10_3d <- STFDF_pm10_2005_2010[,"2005-06-01::2005-06-03"]
str(STFDF_pm10_3d)
```

We create the empty spatial grid.

```{r}
library(raster)
sp_area <- STFDF_pm10_3d@sp
proj <- proj4string(STFDF_pm10_3d@sp)
rs_area <- raster(extent(sp_area), res = 0.05)
sp_grid_area <- SpatialPoints(rasterToPoints(rs_area), CRS(proj))
```

Perform the krigging

```{r, cache = TRUE}
DE_pred <- STF(sp=sp_grid_area, time=STFDF_pm10_3d@time)
DE_kriged <- krigeST(pm10~1, data=STIDF_pm10_3d, newdata=DE_pred,
                    modelList=separableModel)

stplot(DE_kriged)
```

